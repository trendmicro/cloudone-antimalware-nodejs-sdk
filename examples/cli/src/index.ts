import * as fs from "fs";

import {
  AmaasGrpcClient,
  AmaasCredentials,
} from "@amaas/amaas-grpc-node-client";

/**
 * Handle environment variables.
 */
const amaasHostName = process.env?.TM_AM_SERVER_ADDR || "";
const creds: AmaasCredentials = {
  credsType: process.env?.TM_AM_AUTH_KEY_TYPE === "token" ? "token" : "apikey",
  secret: process.env?.TM_AM_AUTH_KEY || "",
};

/**
 * Runs single file scan.
 * Initializing a scan client class uses AmaasGrpcClient() and using AmaasGrpcClient.scanFile() to scan file.
 * @param {string} filePath the file path to scan
 * @return {Promise} void
 */
const runScanAsyncAmaasGrpcClient = async (filePath: string): Promise<void> => {
  const amaasGrpcClient = new AmaasGrpcClient(amaasHostName, creds);

  if (amaasGrpcClient) {
    await amaasGrpcClient.scanFile(filePath).then(
      (result) => {
        console.log(
          `runScanAsyncAmaasGrpcClient result:  ${JSON.stringify(result)}`
        );
        amaasGrpcClient.close();
      },
      (reason) => {
        throw reason;
      }
    );
  }
};

/**
 * Runs concurrent file scan.
 * Initializing a scan client class uses AmaasGrpcClient() and using AmaasGrpcClient.scanFile() to scan file.
 * @param {string} pathName the folder path which contains the files to scan
 * @return {Promise} void
 */
const runBatchScanAmaasGrpcClient = async (pathName: string): Promise<void> => {
  const amaasGrpcClient = new AmaasGrpcClient(amaasHostName, creds);

  if (amaasGrpcClient) {
    if (pathName.charAt(pathName.length - 1) !== "/") {
      pathName += "/";
    }

    const fileNames = fs
      .readdirSync(pathName, { withFileTypes: true })
      .filter((item) => !item.isDirectory())
      .map((item) => `${pathName}${item.name}`);

    console.log(`Total ${fileNames.length} files to scan:`);

    const actions = fileNames.map((fileName) => {
      return amaasGrpcClient.scanFile(fileName);
    });
    await Promise.all(actions).then(
      (results) => {
        console.log("runBatchScanAmaasGrpcClient result:");
        results.forEach((result) => {
          console.log(JSON.stringify(result));
        });
        amaasGrpcClient.close();
      },
      (reason) => {
        throw reason;
      }
    );
  }
};

(async () => {
  // Examples of using AmaasGrpcClient
  await runScanAsyncAmaasGrpcClient("node_modules/@grpc/grpc-js/src/admin.ts");
  await runBatchScanAmaasGrpcClient("node_modules/@grpc/grpc-js/src");
})();

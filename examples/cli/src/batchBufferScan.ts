import { readdirSync, readFileSync } from 'fs'

import {
  AmaasGrpcClient,
  AmaasCredentials
} from '@amaas/amaas-grpc-node-client'

/**
 * Handle environment variables.
 */
const amaasHostName = process.env?.TM_AM_SERVER_ADDR ?? ''
const creds: AmaasCredentials = {
  credsType: process.env?.TM_AM_AUTH_KEY_TYPE === 'token' ? 'token' : 'apikey',
  secret: process.env?.TM_AM_AUTH_KEY ?? ''
}

/**
 * runConcurrentBufferScan function
 *
 * Create a scan client instance using AmaasGrpcClient class.
 * Store content of file in buffer before scanning. Run
 * AmaasGrpcClient.scanBuffer() concurrently to scan files under
 * a directory.
 *
 * @param name - Directory to scan
 */
const runConcurrentBufferScan = async (directoryName: string): Promise<void> => {
  console.info(`\nScanning buffer '${directoryName}'`)
  const amaasGrpcClient = new AmaasGrpcClient(amaasHostName, creds)
  if (directoryName.charAt(directoryName.length - 1) !== '/') {
    directoryName += '/'
  }
  const filesToScan = readdirSync(directoryName, { withFileTypes: true })
    .filter(item => !item.isDirectory())
    .map(item => `${directoryName}${item.name}`)
  const actions = filesToScan.map(async fileName => {
    const buff = readFileSync(fileName)
    return await amaasGrpcClient.scanBuffer(fileName, buff)
  })
  await Promise.all(actions)
    .then(results => {
      results.forEach(result => {
        console.log(JSON.stringify(result))
      })
    })
    .catch(err => {
      throw err
    })
    .finally(() => {
      amaasGrpcClient.close()
    })
}

void (async () => {
  // Examples of using AmaasGrpcClient
  await runConcurrentBufferScan('node_modules/@grpc/grpc-js/src')
})()

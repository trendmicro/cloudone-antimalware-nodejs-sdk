# Cloud One Antimalware API library for JavaScript Documentation

The AMaaS NodeJS Client SDK is a software development kit used for interacting with Trend Cloud One AMaaS service. It is used to build applications on top of the Trend Cloud One AMaaS platform.

## Prerequisites

Before installing the SDK, ensure that the following prerequisites are met:

- NodeJS version 16.20.1+, 18.x or above
- Trend Cloud One account with a chosen region - for more information, see the [Trend Cloud One account document](https://cloudone.trendmicro.com/docs/identity-and-account-management/c1-user-new/).
- A Trend Cloud One API key - for more information, see the [Trend Cloud One API key documentation](https://cloudone.trendmicro.com/docs/identity-and-account-management/c1-api-key/).

## Installation

To install the SDK's NodeJS package, run the following commands in your NodeJS application folder.

```sh
npm install cloudone-vsapi
```

## Authentication

To authenticate with the API, you need an Trend Cloud One API key. Sign up for a [Trend Cloud One account](https://cloudone.trendmicro.com/docs/identity-and-account-management/c1-user-new/) and follow the instructions on [Manage Trend Cloud One API Keys](https://cloudone.trendmicro.com/docs/identity-and-account-management/c1-api-key/) to obtain an API key.

When creating a Trend Cloud One account, choose a region for the account. All of the account data, as well as the security data for the Trend Cloud One security services in the account, is stored in that region. For more information, see the [Trend Cloud One regions documentation](https://cloudone.trendmicro.com/docs/identity-and-account-management/c1-regions/).

### Usage

To initiate a new instance of the AmaasGrpcClient, we need to supply the AMaaSHostName and Cloud One API Key.

```typescript
import { AmaasGrpcClient } from "cloudone-vsapi";

// Replace {REGION} with the region of your Cloud One account
const amaasHostName = "antimalware.{REGION}.cloudone.trendmicro.com:443";

// Replace {YOUR_OWN_CLOUD_ONE_API_KEY} with your own Cloud One API key
const key = { YOUR_OWN_CLOUD_ONE_API_KEY };

// Create a new instance of the AmaasGrpcClient class using the key
const scanClient = new AmaasGrpcClient(amaasHostName, key);
```

## API Reference

### `AmaasGrpcClient`

The AmaasGrpcClient class is the main class of the SDK and provides methods to interact with the API.

#### `constructor( amaasHostName: string, credent: string, timeout: number | undefined = 180, enableTLS: boolean | undefined = true)`

Create a new instance of the `AmaasGrpcClient` class.

**_Parameters_**

| Parameter     | Description                                                                              | Default value |
| ------------- | ---------------------------------------------------------------------------------------- | ------------- |
| amaasHostName | The AMaaS server address.                                                                |               |
| credent       | Your own Cloud One API Key.                                                              |               |
| timeout       | Timeout to cancel the connection to server in seconds.                                   | 180           |
| enableTLS     | Enable or disable TLS. TLS should always be enabled when connecting to the AMaaS server. | true          |

**_Return_**
An AmaasGrpcClient instance

#### `scanFile(name: string): Promise<AmaasScanResultObject>`

Scan a file for malware and retrieves response data from the API.

**_Parameters_**

| Parameter | Description                                                              | Default value |
| --------- | ------------------------------------------------------------------------ | ------------- |
| name      | The name of the file with path of directory containing the file to scan. |               |

**_Return_**
A Promise that resolves to the API response data.

#### `scanBuffer(fileName: string, buff: Buffer): Promise<AmaasScanResultObject>`

Scan a buffer for malware and retrieves response data from the API.

**_Parameters_**

| Parameter | Description                                                                                         | Default value |
| --------- | --------------------------------------------------------------------------------------------------- | ------------- |
| fileName  | The name of the file or object the buffer is created from. The name is used to identify the buffer. |               |
| buff      | The buffer to scan.                                                                                 |               |

**_Return_**
A Promise that resolves to the API response data.

#### `close(): void`

Close connection to the AMaaS server.

**_Parameters_**
None

**_Return_**
void

#### `setLoggingLevel(level: LogLevel): void`

For configuring the SDK's active logging level. The change is applied globally to all AMaaS Client instances. Default level is `LogLevel.OFF`, corresponding to all logging disabled. If logging is enabled, unless custom logging is configured using `configLoggingCallback()` logs will be written to stdout.

**_Parameters_**

| Parameter        | Description                                                                                                                                    |
| ---------------- | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| level (LogLevel) | Valid values are LogLevel.OFF, LogLevel.FATAL, LogLevel.ERROR, LogLevel.WARN, LogLevel.INFO, and LogLevel.DEBUG; default level is LogLevel.OFF |

---

**_Return_**
void

#### `configLoggingCallback(LogCallback: Function): void`

For setting up custom logging by provisioning the SDK with a custom callback function that is invoked whether the SDK wants to record a log.

**_Parameters_**

| Parameter   | Description                                                          |
| ----------- | -------------------------------------------------------------------- |
| LogCallback | A function with the type `(level LogLevel, message: string) => void` |

**_Return_**
void

### `AmaasScanResultObject`

The AmaasScanResultObject interface defines the structure of the response data that is retrieved from our API.
The following are the fields in the interface.

```typescript
interface AmaasScanResultObject {
  scanTimestamp: string        // Timestamp of the scan in ISO 8601 format
  version: string              // Scan result schema version
  fileName: string             // Name of the file scanned
  scanId: string               // ID of the scan
  scanResult: number           // Number of malwares found. A value of 0 means no malware was found
  foundMalwares: [             // A list of malware names and the filenames found by AMaaS
    {
      fileName: string; // File name which found the malware
      malwareName: string; // Malware name
    },
  ];
}
```

### `LogLevel`

```typescript
enum LogLevel {
  OFF, // 0
  FATAL, // 1
  ERROR, // 2
  WARN, // 3
  INFO, // 4
  DEBUG, // 5
}
```

## Code Example

The following is an example of how to use the SDK to scan a file or buffer for malware and retrieve the scan results from our API.

```typescript
import { AmaasGrpcClient, LogLevel } from "cloudone-vsapi";
import { readFileSync } from "fs/promises";

// Replace __REGION__ with the region of your Cloud One account
const amaasHostName = "antimalware.__REGION__.cloudone.trendmicro.com:443";
const credent = "YOUR_OWN_CLOUD_ONE_API_KEY";

let scanClient = undefined;

try {
  scanClient = new AmaasGrpcClient(amaasHostName, credent);

  const logCallback = (level: LogLevel, message: string): void => {
    console.log(`logCallback is called, level: ${level}, message: ${message}`);
  };
  scanClient.setLoggingLevel(LogLevel.DEBUG);
  scanClient.configLoggingCallback(logCallback);

  // Example of scanFile
  const fileToScan = "path/to/file.ext";
  const fileScanResult = await scanClient.scanFile(fileToScan);
  console.log(`Number of malware found: ${result.scanResult}`); // Scan result handling

  // Example of scanBuffer
  const buff = await readFileSync(fileToScan);
  const bufferScanResult = await scanClient.scanBuffer(
    "THE_FILE_NAME_OR_IDENTIFIER",
    buff
  );
  console.log(
    `Number of malware found in buffer: ${bufferScanResult.scanResult}`
  );
} catch (error) {
  // Error handling
  console.error("Error occurred:", error.message);
} finally {
  if (typeof scanClient !== "undefined") {
    scanClient.close();
  }
}
```

## Errors

The built-in JavaScript `Error` object with name "`Error`" will be thrown when error occurs.

### Common errors

The actual message in the following table may be vary in different environment.

| Sample Message                                                                  | Description and handling                                                                                                                                        |
| ------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Error: Name resolution failed for target dns:{server_address}                   | There is a network issue. Please verify the network connection to AMaaS server, and make sure the server address specified in the `AmaasGrpcClient` is correct. |
| Error: Failed to create scan client. Could not parse target name ""             | The AMaaS server address is not set or is empty. Please make sure the server address specified in the `AmaasGrpcClient` is correct.                             |
| Error: You are not authenticated. Invalid C1 token or Api Key                   | The API key is invalid. Please make sure a correct Cloud One Api key or Bearer token is used.                                                                   |
| Error: Failed to open file. ENOENT: no such file or directory, stat {file_path} | The {file_path} specified in `scanFile` cannot be found. Please make sure the file exists and {file_path} specified is correct.                                 |
| Error: Failed to open file. EACCES: permission denied, open {file_path}         | There is a file access permission issue. Please make sure the SDK has read permission of the {file_path} specified in `scanFile`.                               |

BUILD_MAJOR ?= 0
BUILD_MINOR ?= 0
BUILD_PATCH ?= 0
BUILD_NUMBER ?= 1
TM_AM_LOG_LEVEL ?= debug

REPOSITROY := amaas/amaas
IMAGE_NAME_LOCAL := $(REPOSITROY):$(BUILD_MAJOR).$(BUILD_MINOR).$(BUILD_PATCH)-$(BUILD_NUMBER)

# BSD sed does not support --version argument, use this to check if the sed is GNU or BSD one
ifeq ($(shell sed --version >/dev/null 2>&1; echo $$?),0)
SED := sed -i
else
SED := sed -i ''
endif

all: build clean

build:
	@echo "The build version will use the following values:"
	@echo "BUILD_MAJOR=$(BUILD_MAJOR)"
	@echo "BUILD_MINOR=$(BUILD_MINOR)"
	@echo "BUILD_PATCH=$(BUILD_PATCH)"
	@echo "BUILD_NUMBER=$(BUILD_NUMBER)"
	$(SED) 's/__PACKAGE_VERSION__/$(BUILD_MAJOR).$(BUILD_MINOR).$(BUILD_PATCH)-$(BUILD_NUMBER)/' ./dist_files/*/package.json
	docker build \
		-t $(IMAGE_NAME_LOCAL) \
		--build-arg TM_AM_LOG_LEVEL=$(TM_AM_LOG_LEVEL) \
		.
	$(SED) 's/$(BUILD_MAJOR).$(BUILD_MINOR).$(BUILD_PATCH)-$(BUILD_NUMBER)/__PACKAGE_VERSION__/' ./dist_files/*/package.json
	mkdir -p output
	docker run --rm $(IMAGE_NAME_LOCAL) tar -cz pkg/amaas-amaas-grpc-node-client-$(BUILD_MAJOR).$(BUILD_MINOR).$(BUILD_PATCH)-$(BUILD_NUMBER).tgz | tar xzf - -C output
	docker run --rm $(IMAGE_NAME_LOCAL) tar -cz types/types-amaas__amaas-grpc-node-client-$(BUILD_MAJOR).$(BUILD_MINOR).$(BUILD_PATCH)-$(BUILD_NUMBER).tgz | tar xzf - -C output

test:
	docker build \
		--target unit_test \
		-t $(IMAGE_NAME_LOCAL) \
		--build-arg TM_AM_LOG_LEVEL=$(TM_AM_LOG_LEVEL) \
		.

clean:
	-@docker rmi $(IMAGE_NAME_LOCAL) || true

.PHONY: all build test clean

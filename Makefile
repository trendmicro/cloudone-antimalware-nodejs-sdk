IMAGE_NAME := cloudone-vsapi:latest

BUILD_MAJOR ?= 1
BUILD_MINOR ?= 0
BUILD_PATCH ?= 0

TM_AM_LOG_LEVEL ?= debug

all: build clean

build:
	cp protos/scan.proto scan.proto
	docker build \
		-t $(IMAGE_NAME) \
		--build-arg PACK_CMD=pack \
		--build-arg TM_AM_LOG_LEVEL=$(TM_AM_LOG_LEVEL) \
		.
	mkdir -p output
	docker run --rm $(IMAGE_NAME) tar -cz cloudone-vsapi-$(BUILD_MAJOR).$(BUILD_MINOR).$(BUILD_PATCH).tgz | tar xzf - -C output

test:
	cp protos/scan.proto scan.proto
	docker build \
		--target unit_test \
		-t $(IMAGE_NAME) \
		--build-arg TM_AM_LOG_LEVEL=$(TM_AM_LOG_LEVEL) \
		.

clean:
	-@docker rmi $(IMAGE_NAME) || true
	rm -f scan.proto

.PHONY: all build test clean

# AMaaS NodeJS SDK

A TypeScript library for interacting with the AMaaS Service API.

## Prerequisites

- NodeJS (16.16.0+)
- [CloudOne API Key](https://cloudone.trendmicro.com/docs/identity-and-account-management/c1-api-key/)
- Docker ([Docker Desktop](https://www.docker.com/products/docker-desktop/) or [Rancher Desktop](https://rancherdesktop.io/))

## Build SDK

1. Export environment variables. Substitute YOUR EMAIL and API KEY in the following commands.

   ```sh
   export BUILD_MAJOR=1
   export BUILD_MINOR=0
   export BUILD_PATCH=0
   export BUILD_NUMBER=1
   ```

3. Run make command in current directory.

   ```sh
   make all
   ```

   - Two artifacts will be generated and can be found under `/output/`.

     - `/output/pkg/`: amaas-amaas-grpc-node-client-1.0.0-1.tgz - the amaas grpc client node package
     - `/output/types/`: types-amaas\_\_amaas-grpc-node-client-1.0.0-1.tgz - the type declaration package for the node package

## Test SDK

Two examples, one for CLI and one for AWS Lambda Function, are available under `/examples/` for testing the SDK.

### Use CLI example

1. Go to `/examples/cli/` in current directory.

   ```sh
   cd examples/cli/
   ```

2. Export environment variables. Substitute API KEY with CloudOne API KEY in the following commands. API KEY should be in the same region of server address.

   ```sh
   export TM_AM_SERVER_ADDR=antimalware.us-1.cloudone.trendmicro.com:443
   export TM_AM_AUTH_KEY=<API KEY>
   export TM_AM_AUTH_KEY_TYPE=apikey
   export TM_AM_LOG_LEVEL=<info | debug> # Optional
   ```

3. Install SDK dependency packages.

   ```sh
   npm install
   ```

4. Install AMaaS gRPC node client package.

   ```sh
   npm install ../../output/pkg/amaas-amaas-grpc-node-client-1.0.0-1.tgz
   ```

5. Install type declaration package of AMaaS gRPC node client.

   ```sh
   npm install ../../output/types/types-amaas__amaas-grpc-node-client-1.0.0-1.tgz --save-dev
   ```

6. Build example.

   To build fileScan.ts:
   ```sh
   SOURCE=fileScan npm run build
   ```

   To build bufferScan.ts:
   ```sh
   SOURCE=bufferScan npm run build
   ```

   To build batchFileScan.ts:
   ```sh
   SOURCE=batchFileScan npm run build
   ```

   To build batchBufferScan.ts:
   ```sh
   SOURCE=batchBufferScan npm run build
   ```

7. Run example.

   ```sh
   npm run client
   ```

### Use Lambda example

1. Create a Lambda Function on AWS with following runtime settings.

   | Runtime                  | Handler       | Architecture    |
   | :----------------------- | :------------ | :-------------- |
   | Node.js 16.16.x or above | index.handler | x86_64 or arm64 |

2. Configure Lambda Function environment variables on AWS with following settings. Substitute API KEY with CloudOne API Key. API KEY should be in the same region of server address.

   | Key                 | Value                    | Optional |
   | :------------------ | :----------------------- | :------- |
   | TM_AM_SERVER_ADDR   | antimalware.us-1.cloudone.trendmicro.com:443 | No       |
   | TM_AM_AUTH_KEY      | \<API KEY\>              | No       |
   | TM_AM_AUTH_KEY_TYPE | apikey                   | No       |
   | TM_AM_LOG_LEVEL     | \<info \| debug \>       | Yes      |

3. Go to `/examples/lambda/` in current directory.

   ```sh
   cd examples/lambda/
   ```

4. Install SDK dependency packages.

   ```sh
   npm install
   ```

5. Install AMaaS gRPC node client package.

   ```sh
   npm install ../../output/pkg/amaas-amaas-grpc-node-client-1.0.0-1.tgz
   ```

6. Install type declaration package of AMaaS gRPC node client.

   ```sh
   npm install ../../output/types/ types-amaas__amaas-grpc-node-client-1.0.0-1.tgz --save-dev
   ```

7. Build example.

   To build fileScan.ts:
   ```sh
   SOURCE=fileScan npm run build
   ```

   To build bufferScan.ts:
   ```sh
   SOURCE=bufferScan npm run build
   ```

   To build bufferS3Scan.ts:
   ```sh
   SOURCE=bufferS3Scan npm run build
   ```

   To build batchFileScan.ts:
   ```sh
   SOURCE=batchFileScan npm run build
   ```

   To build batchBufferScan.ts:
   ```sh
   SOURCE=batchBufferScan npm run build
   ```

   - A zip file containing index.js and index.js.map will be generated under `/examples/lambda/dist/`.

8. Deploy `/examples/lambda/dist/index.zip` to Lambda Function created in step 1.

9. Create a test in Lambda Function and run the test.

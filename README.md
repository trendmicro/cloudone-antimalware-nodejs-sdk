# AMaaS gRPC Node Client SDK

A TypeScript library for interacting with the AMaaS Service API.

## Prerequisites

- NodeJS (16.16.0+)
- [Trend Micro JFrog Artifactory Repository API Key](https://wiki.jarvis.trendmicro.com/x/qjq-a)
- [CloudOne API Key](https://cloudone.trendmicro.com/docs/identity-and-account-management/c1-api-key/)
- Docker ([Docker Desktop](https://www.docker.com/products/docker-desktop/) or [Rancher Desktop](https://rancherdesktop.io/))

## Build SDK

1. Go to `/packages/` in current directory.

   ```sh
   cd packages/
   ```

2. Export environment variables. Substitute YOUR EMAIL and API KEY in the following commands.

   ```sh
   export BUILD_MAJOR=1
   export BUILD_MINOR=0
   export BUILD_PATCH=0
   export BUILD_NUMBER=1
   export JFROG_USER_EMAIL=<YOUR EMAIL>
   export JFROG_API_KEY=<API KEY>
   ```

3. Run make command.

   ```sh
   make -f Makefile.dev build
   ```

   - Two artifacts will be generated and can be found under `/packages/output/`.

     - `/packages/output/pkg/`: amaas-amaas-grpc-node-client-1.0.0-1.tgz - the amaas grpc client node package
     - `/packages/output/types/`: types-amaas\_\_amaas-grpc-node-client-1.0.0-1.tgz - the type declaration package for the node package

## Test SDK

Two examples, one for CLI and one for AWS Lambda Function, are available under `/examples/` for testing the SDK.

### Use CLI example

1. Go to `/examples/cli/` in current directory.

   ```sh
   cd examples/cli/
   ```

2. Export environment variables. Substitute API KEY with CloudOne API KEY in the following commands.

   ```sh
   export TM_AM_SERVER_ADDR=test.amaastest.com:50051
   export TM_AM_AUTH_KEY=<API KEY>
   export TM_AM_AUTH_KEY_TYPE=apikey
   export TM_AM_LOG_LEVEL=<info | debug> # Optional
   ```

3. Install SDK dependency packages.

   ```sh
   npm install
   ```

4. Install AMaaS gRPC node client package.

   ```sh
   npm install ../../packages/output/pkg/amaas-amaas-grpc-node-client-1.0.0-1.tgz
   ```

5. Install type declaration package of AMaaS gRPC node client.

   ```sh
   npm install ../../packages/output/types/types-amaas__amaas-grpc-node-client-1.0.0-1.tgz
   ```

6. Build example.

   ```sh
   npm run build
   ```

7. Run example.

   ```sh
   npm run client
   ```

### Use Lambda example

1. Create a Lambda Function on AWS with following runtime settings.

   | Runtime                  | Handler       | Architecture    |
   | :----------------------- | :------------ | :-------------- |
   | Node.js 16.16.x or above | index.handler | x86_64 or arm64 |

2. Configure Lambda Function environment variables on AWS with following settings. Substitute API KEY with CloudOne API Key.

   | Key                 | Value                    | Optional |
   | :------------------ | :----------------------- | :------- |
   | TM_AM_SERVER_ADDR   | test.amaastest.com:50051 | No       |
   | TM_AM_AUTH_KEY      | \<API KEY\>              | No       |
   | TM_AM_AUTH_KEY_TYPE | apikey                   | No       |
   | TM_AM_LOG_LEVEL     | \<info \| debug \>       | Yes      |

3. Go to `/examples/lambda/` in current directory.

   ```sh
   cd examples/lambda/
   ```

4. Install SDK dependency packages.

   ```sh
   npm install
   ```

5. Install AMaaS gRPC node client package.

   ```sh
   npm install ../../packages/output/pkg/amaas-amaas-grpc-node-client-1.0.0-1.tgz
   ```

6. Install type declaration package of AMaaS gRPC node client.

   ```sh
   npm install ../../packages/output/types/types-amaas__amaas-grpc-node-client-1.0.0-1.tgz
   ```

7. Build example.

   ```sh
   npm run build
   ```

   - A zip file containing index.js and index.js.map will be generated under `/examples/lambda/dist/`.

8. Deploy `/examples/lambda/dist/index.zip` to Lambda Function created in step 1.

9. Create a test in Lambda Function and run the test.
